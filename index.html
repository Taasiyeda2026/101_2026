<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>טופס 101 - כרטיס עובד ובקשה להקלה במס</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Heebo', Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}

.app-container {
  max-width: 900px;
  margin: 0 auto;
}

.header {
  background: white;
  border-radius: 16px 16px 0 0;
  padding: 24px;
  text-align: center;
  border-bottom: 3px solid #667eea;
}

.header h1 {
  color: #1a1a2e;
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 8px;
}

.header p {
  color: #666;
  font-size: 14px;
}

.form-container {
  background: white;
  border-radius: 0 0 16px 16px;
  padding: 24px;
}

.section {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
  border-right: 4px solid #667eea;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  color: #1a1a2e;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-title .icon {
  width: 28px;
  height: 28px;
  background: #667eea;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 14px;
  font-weight: 700;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  font-size: 13px;
  font-weight: 500;
  color: #444;
  margin-bottom: 6px;
}

.form-group input,
.form-group select {
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group input[readonly] {
  background: #e9ecef;
  color: #495057;
  cursor: not-allowed;
}

.employer-fixed {
  background: #e8f4f8;
  border-right-color: #17a2b8;
}

.employer-fixed .section-title .icon {
  background: #17a2b8;
}

.radio-group {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.radio-option {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  padding: 8px 12px;
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  transition: all 0.2s;
}

.radio-option:hover {
  border-color: #667eea;
}

.radio-option input {
  accent-color: #667eea;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.checkbox-option {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  cursor: pointer;
  padding: 10px;
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  transition: all 0.2s;
  font-size: 13px;
}

.checkbox-option:hover {
  border-color: #667eea;
  background: #f0f4ff;
}

.checkbox-option input {
  accent-color: #667eea;
  margin-top: 2px;
  flex-shrink: 0;
}

.children-container {
  background: white;
  border-radius: 8px;
  padding: 16px;
  margin-top: 12px;
}

.child-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr auto auto 40px;
  gap: 12px;
  align-items: end;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-bottom: 8px;
  position: relative;
}

.child-row .remove-child-btn {
  align-self: center;
}

.child-row input {
  padding: 8px 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 13px;
  font-family: inherit;
}

.add-child-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.add-child-btn:hover {
  background: #5a6fd6;
}

.remove-child-btn {
  background: #ff4757;
  color: white;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.signature-section {
  background: white;
  border-radius: 8px;
  padding: 16px;
  margin-top: 12px;
}

.signature-canvas {
  border: 2px dashed #667eea;
  border-radius: 8px;
  background: #fafafa;
  cursor: crosshair;
  touch-action: none;
}

.signature-buttons {
  display: flex;
  gap: 12px;
  margin-top: 12px;
}

.clear-btn {
  background: #f1f1f1;
  border: 1px solid #ddd;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-family: inherit;
  font-size: 13px;
}

.declaration-box {
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 8px;
  padding: 16px;
  margin-top: 16px;
  font-size: 14px;
  line-height: 1.8;
}

.submit-section {
  text-align: center;
  padding: 24px;
}

.submit-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 16px 48px;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
}

.note {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}

.step-indicator {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 24px;
}

.step {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: #666;
  font-size: 14px;
}

.step.active {
  background: #667eea;
  color: white;
}

.step.completed {
  background: #4caf50;
  color: white;
}

.nav-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 24px;
}

.nav-btn {
  padding: 12px 24px;
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.nav-btn.prev {
  background: #f1f1f1;
  border: 1px solid #ddd;
  color: #444;
}

.nav-btn.next {
  background: #667eea;
  border: none;
  color: white;
}

.form-step {
  display: none;
}

.form-step.active {
  display: block;
}

@media (max-width: 600px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .child-row {
    grid-template-columns: 1fr 1fr 1fr auto auto 40px;
  }
  
  .radio-group {
    flex-direction: column;
  }
}
</style>
</head>
<body>

<div class="app-container">
  <div class="header">
    <h1>טופס 101 - כרטיס עובד</h1>
    <p>ובקשה להקלה ולתיאום מס על ידי המעסיק | לפי תקנות מס הכנסה (ניכוי ממשכורת ומשכר עבודה), התשנ"ג-1993</p>
  </div>
  
  <div class="form-container">
    <div class="step-indicator">
      <div class="step active" id="step1">1</div>
      <div class="step" id="step2">2</div>
      <div class="step" id="step3">3</div>
      <div class="step" id="step4">4</div>
      <div class="step" id="step5">5</div>
    </div>

    <form id="form101">
      
      <div class="form-step active" id="formStep1">
        <div class="section employer-fixed">
          <div class="section-title">
            <span class="icon">א</span>
            פרטי המעסיק (קבוע)
          </div>
          <div class="form-grid">
            <div class="form-group full-width">
              <label>שם המעסיק</label>
              <input type="text" id="employerName" value="תעשיידע – תעשייה למען חינוך מתקדם ע״ר" readonly>
            </div>
            <div class="form-group">
              <label>מספר תיק ניכויים / ח.פ / עמותה</label>
              <input type="text" id="employerTikNikuyim" value="9935176040" readonly>
            </div>
            <div class="form-group">
              <label>כתובת</label>
              <input type="text" id="employerAddress" value="דניאל פריש 3, תל אביב" readonly>
            </div>
            <div class="form-group">
              <label>טלפון</label>
              <input type="tel" id="employerPhone" value="050-8321062" readonly>
            </div>
            <div class="form-group">
              <label>מייל</label>
              <input type="email" id="employerEmail" value="office@think.org.il" readonly>
            </div>
            <div class="form-group">
              <label>איש קשר</label>
              <input type="text" id="employerContact" value="עידן נחום" readonly>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">
            <span class="icon">ב</span>
            פרטי העובד/ת
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>מספר תעודת זהות (9 ספרות) *</label>
              <input type="text" id="idNumber" maxlength="9" pattern="[0-9]{9}" required>
            </div>
            <div class="form-group">
              <label>שם משפחה *</label>
              <input type="text" id="lastName" required>
            </div>
            <div class="form-group">
              <label>שם פרטי *</label>
              <input type="text" id="firstName" required>
            </div>
            <div class="form-group">
              <label>תאריך לידה *</label>
              <input type="date" id="birthDate" required>
            </div>
          </div>
          
          <div class="form-grid" style="margin-top: 16px;">
            <div class="form-group">
              <label>רחוב/שכונה *</label>
              <input type="text" id="street" required>
            </div>
            <div class="form-group">
              <label>מספר בית *</label>
              <input type="text" id="houseNumber" required>
            </div>
            <div class="form-group">
              <label>עיר/ישוב *</label>
              <input type="text" id="city" required>
            </div>
            <div class="form-group">
              <label>מיקוד</label>
              <input type="text" id="zipCode" maxlength="7">
            </div>
            <div class="form-group">
              <label>טלפון *</label>
              <input type="tel" id="phone" required>
            </div>
            <div class="form-group">
              <label>טלפון נייד</label>
              <input type="tel" id="mobile">
            </div>
            <div class="form-group full-width">
              <label>כתובת דואר אלקטרוני</label>
              <input type="email" id="email">
            </div>
          </div>

          <div class="form-grid" style="margin-top: 16px;">
            <div class="form-group">
              <label>מין *</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="gender" value="male" required> זכר
                </label>
                <label class="radio-option">
                  <input type="radio" name="gender" value="female"> נקבה
                </label>
              </div>
            </div>
            <div class="form-group">
              <label>מצב משפחתי *</label>
              <select id="maritalStatus" required>
                <option value="">בחר...</option>
                <option value="single">רווק/ה</option>
                <option value="married">נשוי/אה</option>
                <option value="divorced">גרוש/ה</option>
                <option value="widowed">אלמן/ה</option>
                <option value="separated">פרוד/ה</option>
              </select>
            </div>
          </div>

          <div class="form-grid" style="margin-top: 16px;">
            <div class="form-group">
              <label>חבר קיבוץ/מושב שיתופי</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="kibbutzMember" value="no" required> לא
                </label>
                <label class="radio-option">
                  <input type="radio" name="kibbutzMember" value="yesTransfer"> כן, הכנסות מועברות לקיבוץ
                </label>
                <label class="radio-option">
                  <input type="radio" name="kibbutzMember" value="yesNoTransfer"> כן, הכנסות אינן מועברות לקיבוץ
                </label>
              </div>
            </div>
            <div class="form-group">
              <label>חבר בקופת חולים</label>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="kupat" value="no"> לא
                </label>
                <label class="radio-option">
                  <input type="radio" name="kupat" value="yes"> כן
                </label>
              </div>
            </div>
            <div class="form-group" id="kupatNameGroup" style="display: none;">
              <label>שם קופת החולים</label>
              <input type="text" id="kupatName">
            </div>
          </div>
        </div>
        
        <div class="nav-buttons">
          <div></div>
          <button type="button" class="nav-btn next" onclick="nextStep(1)">המשך →</button>
        </div>
      </div>

      <div class="form-step" id="formStep2">
        <div class="section">
          <div class="section-title">
            <span class="icon">ג</span>
            פרטים על ילדים (שבשנת המס טרם מלאו להם 19 שנה)
          </div>
          <div class="children-container" id="childrenContainer">
            <div class="child-row" data-child="1">
              <div class="form-group">
                <label>שם הילד</label>
                <input type="text" name="childName[]">
              </div>
              <div class="form-group">
                <label>מספר זהות</label>
                <input type="text" name="childId[]" maxlength="9">
              </div>
              <div class="form-group">
                <label>תאריך לידה</label>
                <input type="date" name="childBirth[]">
              </div>
              <div class="form-group">
                <label>בחזקתי</label>
                <input type="checkbox" name="childCustody[]">
              </div>
              <div class="form-group">
                <label>קצבה מב"ל</label>
                <input type="checkbox" name="childAllowance[]">
              </div>
              <button type="button" class="remove-child-btn" onclick="removeChild(this)">×</button>
            </div>
          </div>
          <button type="button" class="add-child-btn" onclick="addChild()">+ הוסף ילד</button>
        </div>

        <div class="section">
          <div class="section-title">
            <span class="icon">ד</span>
            פרטים על הכנסות ממעסיק זה
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>תאריך תחילת העבודה *</label>
              <input type="date" id="workStartDate" required>
            </div>
          </div>
          <div class="form-group" style="margin-top: 16px;">
            <label>סוג ההכנסה ממעסיק זה: *</label>
            <div class="income-type-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">
              <label class="radio-option" style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="radio" name="incomeType" value="monthly" required style="margin-left: 8px;"> משכורת חודש
              </label>
              <label class="radio-option" style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="radio" name="incomeType" value="additional" style="margin-left: 8px;"> משכורת נוספת
              </label>
              <label class="radio-option" style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="radio" name="incomeType" value="partial" style="margin-left: 8px;"> משכורת חלקית
              </label>
              <label class="radio-option" style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="radio" name="incomeType" value="daily" style="margin-left: 8px;"> שכר יומי
              </label>
              <label class="radio-option" style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="radio" name="incomeType" value="pension" style="margin-left: 8px;"> קצבה
              </label>
              <label class="radio-option" style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="radio" name="incomeType" value="scholarship" style="margin-left: 8px;"> מלגה
              </label>
            </div>
          </div>
        </div>
        
        <div class="nav-buttons">
          <button type="button" class="nav-btn prev" onclick="prevStep(2)">← חזור</button>
          <button type="button" class="nav-btn next" onclick="nextStep(2)">המשך →</button>
        </div>
      </div>

      <div class="form-step" id="formStep3">
        <div class="section">
          <div class="section-title">
            <span class="icon">ה</span>
            פרטים על הכנסות אחרות
          </div>
          <div class="checkbox-group">
            <label class="checkbox-option">
              <input type="radio" name="otherIncome" value="none" checked>
              אין לי הכנסות אחרות ממשכורת, מקצבה וממלגה
            </label>
            <label class="checkbox-option">
              <input type="radio" name="otherIncome" value="yes">
              יש לי הכנסות אחרות
            </label>
          </div>
          
          <div id="otherIncomeDetails" style="display: none; margin-top: 16px;">
            <div class="checkbox-group">
              <label class="checkbox-option">
                <input type="checkbox" name="otherIncomeType" value="monthly"> משכורת חודש
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="otherIncomeType" value="additional"> משכורת בעד משרה נוספת
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="otherIncomeType" value="partial"> משכורת חלקית
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="otherIncomeType" value="daily"> שכר עבודה (עובד יומי)
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="otherIncomeType" value="pension"> קצבה
              </label>
              <label class="checkbox-option">
                <input type="checkbox" name="otherIncomeType" value="scholarship"> מלגה
              </label>
            </div>
            
            <div class="checkbox-group" style="margin-top: 16px;">
              <label class="checkbox-option">
                <input type="checkbox" id="requestCredits">
                אבקש לקבל נקודות זיכוי ומדרגות מס כנגד הכנסתי זו. איני מקבל/ת אותן בהכנסה אחרת
              </label>
              <label class="checkbox-option">
                <input type="checkbox" id="receiveCreditsElsewhere">
                אני מקבל/ת נקודות זיכוי ומדרגות מס בהכנסה אחרת ועל כן איני זכאי/ת להן כנגד הכנסה זו
              </label>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">
            <span class="icon">ו</span>
            פרטים על בן/בת הזוג
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>מספר תעודת זהות (9 ספרות)</label>
              <input type="text" id="spouseId" maxlength="9">
            </div>
            <div class="form-group">
              <label>שם משפחה</label>
              <input type="text" id="spouseLastName">
            </div>
            <div class="form-group">
              <label>שם פרטי</label>
              <input type="text" id="spouseFirstName">
            </div>
            <div class="form-group">
              <label>תאריך לידה</label>
              <input type="date" id="spouseBirthDate">
            </div>
            <div class="form-group">
              <label>תאריך עלייה (אם רלוונטי)</label>
              <input type="date" id="spouseAliyaDate">
            </div>
          </div>
          <div class="form-group" style="margin-top: 16px;">
            <label>הכנסות בן/בת הזוג</label>
            <div class="spouse-income-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px;">
              <label class="radio-option" style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="radio" name="spouseIncome" value="none" style="margin-left: 8px;"> אין הכנסה
              </label>
              <label class="radio-option" style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="radio" name="spouseIncome" value="work" style="margin-left: 8px;"> עבודה/קצבה/עסק
              </label>
              <label class="radio-option" style="display: flex; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer;">
                <input type="radio" name="spouseIncome" value="other" style="margin-left: 8px;"> הכנסה אחרת
              </label>
            </div>
          </div>
        </div>
        
        <div class="nav-buttons">
          <button type="button" class="nav-btn prev" onclick="prevStep(3)">← חזור</button>
          <button type="button" class="nav-btn next" onclick="nextStep(3)">המשך →</button>
        </div>
      </div>

      <div class="form-step" id="formStep4">
        <div class="section">
          <div class="section-title">
            <span class="icon">ח</span>
            בקשה לפטור או זיכוי ממס
          </div>
          <div class="checkbox-group">
            <label class="checkbox-option">
              <input type="checkbox" id="credit1" checked disabled> 1. אני תושב/ת ישראל (מסומן אוטומטית)
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit2a" onchange="confirmCredit(this, 'נכה 100% / עיוור/ת לצמיתות')"> 2א. אני נכה 100% / עיוור/ת לצמיתות
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit2b" onchange="confirmCredit(this, 'מקבל/ת תגמול חודשי לפי חוק הנכים')"> 2ב. אני מקבל/ת תגמול חודשי לפי חוק הנכים
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit3" onchange="confirmCredit(this, 'תושב/ת קבוע/ה בישוב מזכה')"> 3. אני תושב/ת קבוע/ה בישוב מזכה
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit4" onchange="confirmCredit(this, 'עולה חדש/ה')"> 4. אני עולה חדש/ה
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit5" onchange="confirmCredit(this, 'בן/בת זוג ללא הכנסות')"> 5. בגין בן/בת זוגי המתגורר/ת עימי ואין לו/לה הכנסות
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit6" onchange="confirmCredit(this, 'הורה במשפחה חד הורית')"> 6. אני הורה במשפחה חד הורית החי בנפרד
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit7" onchange="confirmCredit(this, 'ילדים בחזקתי')"> 7. בגין ילדיי שבחזקתי
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit8" onchange="confirmCredit(this, 'ילדיי')"> 8. בגין ילדיי
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit9" onchange="confirmCredit(this, 'הורה יחיד')"> 9. אני הורה יחיד לילדיי שבחזקתי
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit10" onchange="confirmCredit(this, 'ילדים שאינם בחזקתי')"> 10. בגין ילדיי שאינם בחזקתי ואני משתתף/ת בכלכלתם
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit11" onchange="confirmCredit(this, 'הורה לילדים עם מוגבלות')"> 11. אני הורה לילדים עם מוגבלות
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit12" onchange="confirmCredit(this, 'מזונות לבן/בת זוג לשעבר')"> 12. בגין מזונות לבן/בת זוגי לשעבר
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit13" onchange="confirmCredit(this, 'גיל 16-18')"> 13. מלאו לי או לבן/בת זוגי 16 שנים וטרם מלאו 18 שנים
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit14" onchange="confirmCredit(this, 'חייל/ת משוחרר/ת')"> 14. אני חייל/ת משוחרר/ת / שירתתי בשירות לאומי
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit15" onchange="confirmCredit(this, 'סיום לימודים')"> 15. בגין סיום לימודים לתואר אקדמי / התמחות / לימודי מקצוע
            </label>
            <label class="checkbox-option">
              <input type="checkbox" id="credit16" onchange="confirmCredit(this, 'לוחם/ת מילואים')"> 16. שירתתי כלוחם/ת מילואים
            </label>
          </div>
        </div>

        <div class="section">
          <div class="section-title">
            <span class="icon">ט</span>
            אני מבקש/ת תיאום מס מהסיבות הבאות (סמן/י √ בריבוע המתאים)
          </div>
          
          <div class="checkbox-group">
            <label class="checkbox-option">
              <input type="checkbox" id="taxAdj1" onchange="toggleTaxAdjSection(1)"> 
              <strong>1.</strong> לא היתה לי הכנסה מתחילת שנת המס הנוכחית עד לתחילת עבודתי אצל מעסיק זה
            </label>
            <div id="taxAdj1Details" class="tax-adj-details" style="display: none; margin-right: 30px; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px;">
              <p style="font-size: 0.85rem; color: #666;">
                <strong>הערות:</strong><br>
                1. יש לצרף הוכחה כגון: אישור משטרת הגבולות בגין שהייה בחו"ל, אישור מחלה וכיו"ב. בהעדר הוכחה יש לפנות לפקיד השומה.<br>
                2. דמי לידה ודמי אבטלה הינם הכנסה חייבת.
              </p>
            </div>
          </div>
          
          <div class="checkbox-group" style="margin-top: 15px;">
            <label class="checkbox-option">
              <input type="checkbox" id="taxAdj2" onchange="toggleTaxAdjSection(2)"> 
              <strong>2.</strong> יש לי הכנסות נוספות ממשכורת<sup>(1)</sup> כמפורט להלן:
            </label>
            <div id="taxAdj2Details" class="tax-adj-details" style="display: none; margin-top: 15px;">
              <div id="otherEmployersTable">
                <table class="employers-table" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                  <thead>
                    <tr style="background: #e8e8e8;">
                      <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">המס שנוכה</th>
                      <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">ההכנסה החודשית</th>
                      <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">סוג ההכנסה<br>(עבודה/קצבה/מלגה/אחר)</th>
                      <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">מספר תיק ניכויים</th>
                      <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">כתובת</th>
                      <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">שם המעסיק/משלם המשכורת</th>
                      <th style="border: 1px solid #ccc; padding: 8px; width: 30px;"></th>
                    </tr>
                  </thead>
                  <tbody id="otherEmployersBody">
                    <tr class="employer-row">
                      <td style="border: 1px solid #ccc; padding: 4px;"><input type="text" name="otherEmpTax[]" style="width: 100%; border: none; text-align: center;"></td>
                      <td style="border: 1px solid #ccc; padding: 4px;"><input type="text" name="otherEmpIncome[]" style="width: 100%; border: none; text-align: center;"></td>
                      <td style="border: 1px solid #ccc; padding: 4px;">
                        <select name="otherEmpType[]" style="width: 100%; border: none;">
                          <option value="">בחר</option>
                          <option value="עבודה">עבודה</option>
                          <option value="קצבה">קצבה</option>
                          <option value="מלגה">מלגה</option>
                          <option value="אחר">אחר</option>
                        </select>
                      </td>
                      <td style="border: 1px solid #ccc; padding: 4px;"><input type="text" name="otherEmpTik[]" style="width: 100%; border: none; text-align: center;"></td>
                      <td style="border: 1px solid #ccc; padding: 4px;"><input type="text" name="otherEmpAddress[]" style="width: 100%; border: none;"></td>
                      <td style="border: 1px solid #ccc; padding: 4px;"><input type="text" name="otherEmpName[]" style="width: 100%; border: none;"></td>
                      <td style="border: 1px solid #ccc; padding: 4px; text-align: center;">
                        <button type="button" onclick="removeEmployerRow(this)" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer;">×</button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <button type="button" onclick="addEmployerRow()" style="margin-top: 10px; background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">+ הוסף מעסיק נוסף</button>
              </div>
              <p style="font-size: 0.75rem; color: #666; margin-top: 10px;">
                <sup>(1)</sup> "עובד" יחיד המקבל משכורות. "מעסיק" אדם המשלם משכורת. "משכורת" הכנסת עבודה, קצבה, מענק עקב פרישה או מוות, מלגה וכיו"ב.
              </p>
            </div>
          </div>
          
          <div class="checkbox-group" style="margin-top: 15px;">
            <label class="checkbox-option">
              <input type="checkbox" id="taxAdj3" onchange="toggleTaxAdjSection(3)"> 
              <strong>3.</strong> פקיד השומה אישר תיאום לפי אישור מצורף
            </label>
            <div id="taxAdj3Details" class="tax-adj-details" style="display: none; margin-right: 30px; margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 8px;">
              <p style="font-size: 0.85rem; color: #666;">יש לצרף את אישור התיאום שהתקבל מפקיד השומה.</p>
            </div>
          </div>
        </div>
        
        <div class="nav-buttons">
          <button type="button" class="nav-btn prev" onclick="prevStep(4)">← חזור</button>
          <button type="button" class="nav-btn next" onclick="nextStep(4)">המשך →</button>
        </div>
      </div>

      <div class="form-step" id="formStep5">
        <div class="section">
          <div class="section-title">
            <span class="icon">י</span>
            הצהרה וחתימה
          </div>
          
          <div class="declaration-box">
            <strong>אני מצהיר/ה כי הפרטים שמסרתי בטופס זה הינם מלאים ונכונים.</strong><br><br>
            ידוע לי כי השמטה או מסירת פרטים לא נכונים הינה עבירה על פקודת מס הכנסה.<br><br>
            אני מתחייב/ת להודיע למעסיק על כל שינוי שיחול בפרטיי האישיים ובפרטים דלעיל תוך שבוע ימים מתאריך השינוי.
          </div>

          <div class="signature-section">
            <label style="font-weight: 600; margin-bottom: 12px; display: block;">חתימה דיגיטלית</label>
            <p class="note" style="margin-bottom: 12px;">חתום/י באמצעות העכבר או האצבע. החתימה תכלול חותמת זמן אוטומטית בהתאם לתקנות רשות המסים.</p>
            <canvas id="signatureCanvas" class="signature-canvas" width="400" height="150"></canvas>
            <div class="signature-buttons">
              <button type="button" class="clear-btn" onclick="clearSignature()">נקה חתימה</button>
            </div>
          </div>

          <div class="form-grid" style="margin-top: 20px;">
            <div class="form-group">
              <label>תאריך החתימה</label>
              <input type="date" id="signatureDate" readonly>
            </div>
          </div>
        </div>
        
        <div class="nav-buttons">
          <button type="button" class="nav-btn prev" onclick="prevStep(5)">← חזור</button>
        </div>

        <div class="submit-section">
          <button type="button" class="submit-btn" onclick="generatePDF()">
            הפקת טופס 101 חתום (PDF)
          </button>
          <a href="bank-details.html" class="secondary-btn" style="display: inline-block; margin-top: 12px; padding: 12px 24px; background: #f8f9fa; color: #667eea; border: 2px solid #667eea; border-radius: 8px; text-decoration: none; font-weight: 600; text-align: center;">
            טופס פרטי בנק ומסמכים (עובד חדש) →
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
let currentStep = 1;
const totalSteps = 5;

function updateStepIndicator() {
  for (let i = 1; i <= totalSteps; i++) {
    const stepEl = document.getElementById('step' + i);
    stepEl.classList.remove('active', 'completed');
    if (i < currentStep) {
      stepEl.classList.add('completed');
      stepEl.textContent = '✓';
    } else if (i === currentStep) {
      stepEl.classList.add('active');
      stepEl.textContent = i;
    } else {
      stepEl.textContent = i;
    }
  }
}

function showStep(step) {
  document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
  document.getElementById('formStep' + step).classList.add('active');
  updateStepIndicator();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function nextStep(current) {
  if (current < totalSteps) {
    currentStep = current + 1;
    showStep(currentStep);
  }
}

function prevStep(current) {
  if (current > 1) {
    currentStep = current - 1;
    showStep(currentStep);
  }
}

document.querySelectorAll('input[name="kupat"]').forEach(radio => {
  radio.addEventListener('change', function() {
    document.getElementById('kupatNameGroup').style.display = 
      this.value === 'yes' ? 'block' : 'none';
  });
});

document.querySelectorAll('input[name="otherIncome"]').forEach(radio => {
  radio.addEventListener('change', function() {
    document.getElementById('otherIncomeDetails').style.display = 
      this.value === 'yes' ? 'block' : 'none';
  });
});

let childCount = 1;
function addChild() {
  childCount++;
  const container = document.getElementById('childrenContainer');
  const newRow = document.createElement('div');
  newRow.className = 'child-row';
  newRow.dataset.child = childCount;
  newRow.innerHTML = `
    <div class="form-group">
      <label>שם הילד</label>
      <input type="text" name="childName[]">
    </div>
    <div class="form-group">
      <label>מספר זהות</label>
      <input type="text" name="childId[]" maxlength="9">
    </div>
    <div class="form-group">
      <label>תאריך לידה</label>
      <input type="date" name="childBirth[]">
    </div>
    <div class="form-group">
      <label>בחזקתי</label>
      <input type="checkbox" name="childCustody[]">
    </div>
    <div class="form-group">
      <label>קצבה מב"ל</label>
      <input type="checkbox" name="childAllowance[]">
    </div>
    <button type="button" class="remove-child-btn" onclick="removeChild(this)">×</button>
  `;
  container.appendChild(newRow);
}

function removeChild(btn) {
  if (document.querySelectorAll('.child-row').length > 1) {
    btn.closest('.child-row').remove();
  }
}

function confirmCredit(checkbox, creditName) {
  if (checkbox.checked) {
    if (!confirm('האם את/ה בטוח/ה שברצונך לבקש זיכוי עבור: ' + creditName + '?\n\nהצהרה כוזבת עלולה להוביל לעבירה על פקודת מס הכנסה.')) {
      checkbox.checked = false;
    }
  }
}

function toggleTaxAdjSection(num) {
  const checkbox = document.getElementById('taxAdj' + num);
  const details = document.getElementById('taxAdj' + num + 'Details');
  if (details) {
    details.style.display = checkbox.checked ? 'block' : 'none';
  }
}

function addEmployerRow() {
  const tbody = document.getElementById('otherEmployersBody');
  const newRow = document.createElement('tr');
  newRow.className = 'employer-row';
  newRow.innerHTML = `
    <td style="border: 1px solid #ccc; padding: 4px;"><input type="text" name="otherEmpTax[]" style="width: 100%; border: none; text-align: center;"></td>
    <td style="border: 1px solid #ccc; padding: 4px;"><input type="text" name="otherEmpIncome[]" style="width: 100%; border: none; text-align: center;"></td>
    <td style="border: 1px solid #ccc; padding: 4px;">
      <select name="otherEmpType[]" style="width: 100%; border: none;">
        <option value="">בחר</option>
        <option value="עבודה">עבודה</option>
        <option value="קצבה">קצבה</option>
        <option value="מלגה">מלגה</option>
        <option value="אחר">אחר</option>
      </select>
    </td>
    <td style="border: 1px solid #ccc; padding: 4px;"><input type="text" name="otherEmpTik[]" style="width: 100%; border: none; text-align: center;"></td>
    <td style="border: 1px solid #ccc; padding: 4px;"><input type="text" name="otherEmpAddress[]" style="width: 100%; border: none;"></td>
    <td style="border: 1px solid #ccc; padding: 4px;"><input type="text" name="otherEmpName[]" style="width: 100%; border: none;"></td>
    <td style="border: 1px solid #ccc; padding: 4px; text-align: center;">
      <button type="button" onclick="removeEmployerRow(this)" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer;">×</button>
    </td>
  `;
  tbody.appendChild(newRow);
}

function removeEmployerRow(btn) {
  const rows = document.querySelectorAll('#otherEmployersBody .employer-row');
  if (rows.length > 1) {
    btn.closest('tr').remove();
  } else {
    alert('חייב להישאר לפחות שורה אחת');
  }
}

const canvas = document.getElementById('signatureCanvas');
const ctx = canvas.getContext('2d');
let isDrawing = false;
let lastX = 0;
let lastY = 0;

canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('mouseout', stopDrawing);

canvas.addEventListener('touchstart', handleTouchStart);
canvas.addEventListener('touchmove', handleTouchMove);
canvas.addEventListener('touchend', stopDrawing);

function startDrawing(e) {
  isDrawing = true;
  [lastX, lastY] = [e.offsetX, e.offsetY];
}

function draw(e) {
  if (!isDrawing) return;
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.strokeStyle = '#1a1a2e';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.stroke();
  [lastX, lastY] = [e.offsetX, e.offsetY];
}

function handleTouchStart(e) {
  e.preventDefault();
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  isDrawing = true;
  lastX = touch.clientX - rect.left;
  lastY = touch.clientY - rect.top;
}

function handleTouchMove(e) {
  e.preventDefault();
  if (!isDrawing) return;
  const touch = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  const x = touch.clientX - rect.left;
  const y = touch.clientY - rect.top;
  
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(x, y);
  ctx.strokeStyle = '#1a1a2e';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.stroke();
  
  lastX = x;
  lastY = y;
}

function stopDrawing() {
  isDrawing = false;
}

function clearSignature() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

document.getElementById('signatureDate').value = new Date().toISOString().split('T')[0];

function formatHebrewDate(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toLocaleDateString('he-IL');
}

function generatePDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'a4');
  
  const pageWidth = 210;
  const pageHeight = 297;
  const margin = 10;
  const contentWidth = pageWidth - 2 * margin;
  let y = 8;
  
  pdf.setFont('Helvetica');
  
  function drawCell(x, w, h, label, value, labelSize = 6, valueSize = 8) {
    pdf.setDrawColor(0);
    pdf.rect(x, y, w, h);
    pdf.setFontSize(labelSize);
    pdf.setFont('Helvetica', 'normal');
    pdf.setTextColor(80);
    pdf.text(label, x + w - 1, y + 3, { align: 'right' });
    pdf.setFontSize(valueSize);
    pdf.setTextColor(0);
    pdf.setFont('Helvetica', 'bold');
    if (value) {
      pdf.text(String(value), x + w - 1, y + h - 2, { align: 'right' });
    }
  }
  
  function drawSectionHeader(text, icon) {
    pdf.setFillColor(230, 230, 250);
    pdf.rect(margin, y, contentWidth, 7, 'F');
    pdf.setDrawColor(0);
    pdf.rect(margin, y, contentWidth, 7);
    pdf.setFontSize(10);
    pdf.setFont('Helvetica', 'bold');
    pdf.setTextColor(0);
    pdf.text(text + ' .' + icon, pageWidth - margin - 2, y + 5, { align: 'right' });
    y += 7;
  }
  
  function checkbox(checked) {
    return checked ? '[X]' : '[ ]';
  }
  
  pdf.setFontSize(7);
  pdf.setTextColor(100);
  pdf.text('0101/130', margin, y);
  pdf.text('1 / 2 :daf', pageWidth - margin, y, { align: 'right' });
  
  y += 5;
  pdf.setFillColor(200, 200, 255);
  pdf.rect(margin, y, contentWidth, 12, 'F');
  pdf.setDrawColor(0);
  pdf.rect(margin, y, contentWidth, 12);
  
  pdf.setFontSize(14);
  pdf.setTextColor(0);
  pdf.setFont('Helvetica', 'bold');
  pdf.text('TOFES 101 - KARTIS OVED', pageWidth / 2, y + 5, { align: 'center' });
  pdf.setFontSize(8);
  pdf.setFont('Helvetica', 'normal');
  pdf.text('Uvakasha Lehakala Uletieum Mas - Lefi Takanot Mas Hachnasa 1993', pageWidth / 2, y + 10, { align: 'center' });
  
  y += 14;
  const taxYear = new Date().getFullYear();
  pdf.setFontSize(11);
  pdf.setFont('Helvetica', 'bold');
  pdf.text('SHNAT MAS: ' + taxYear, pageWidth / 2, y + 4, { align: 'center' });
  y += 8;
  
  drawSectionHeader('PIRTEI HAMAASIK', 'A');
  const cellH = 10;
  const col4 = contentWidth / 4;
  
  const employerName = document.getElementById('employerName').value || '';
  const employerTik = document.getElementById('employerTikNikuyim').value || '';
  const employerAddress = document.getElementById('employerAddress').value || '';
  const employerPhone = document.getElementById('employerPhone').value || '';
  
  drawCell(margin, col4 * 2, cellH, 'Shem Maasik', employerName);
  drawCell(margin + col4 * 2, col4, cellH, 'Tik Nikuyim', employerTik);
  drawCell(margin + col4 * 3, col4, cellH, 'Telefon', employerPhone);
  y += cellH;
  drawCell(margin, contentWidth, cellH, 'Ktovet', employerAddress);
  y += cellH + 2;
  
  drawSectionHeader('PIRTEI HAOVED', 'B');
  
  const idNum = document.getElementById('idNumber').value || '';
  const lastName = document.getElementById('lastName').value || '';
  const firstName = document.getElementById('firstName').value || '';
  const birthDate = formatHebrewDate(document.getElementById('birthDate').value);
  
  const col3 = contentWidth / 3;
  drawCell(margin, col3, cellH, 'Mispar Zehut', idNum);
  drawCell(margin + col3, col3, cellH, 'Shem Mishpacha', lastName);
  drawCell(margin + col3 * 2, col3, cellH, 'Shem Prati', firstName);
  y += cellH;
  
  drawCell(margin, col3, cellH, 'Taarich Leida', birthDate);
  const gender = document.querySelector('input[name="gender"]:checked');
  const genderText = gender ? (gender.value === 'male' ? 'Zachar' : 'Nekeva') : '';
  drawCell(margin + col3, col3, cellH, 'Min', genderText);
  const marital = document.getElementById('maritalStatus');
  const maritalText = marital.options[marital.selectedIndex]?.text || '';
  drawCell(margin + col3 * 2, col3, cellH, 'Matsav Mishpachti', maritalText);
  y += cellH;
  
  const street = document.getElementById('street').value || '';
  const houseNum = document.getElementById('houseNumber').value || '';
  const city = document.getElementById('city').value || '';
  const zipCode = document.getElementById('zipCode').value || '';
  const fullAddress = street + ' ' + houseNum + ', ' + city + (zipCode ? ' ' + zipCode : '');
  
  drawCell(margin, contentWidth, cellH, 'Ktovet Megurim', fullAddress);
  y += cellH;
  
  const phone = document.getElementById('phone').value || '';
  const mobile = document.getElementById('mobile').value || '';
  const email = document.getElementById('email').value || '';
  
  drawCell(margin, col3, cellH, 'Telefon', phone);
  drawCell(margin + col3, col3, cellH, 'Nayad', mobile);
  drawCell(margin + col3 * 2, col3, cellH, 'Email', email);
  y += cellH + 2;
  
  drawSectionHeader('PIRTIM AL YELADIM (ad gil 19)', 'G');
  
  const childNames = document.querySelectorAll('input[name="childName[]"]');
  const childIds = document.querySelectorAll('input[name="childId[]"]');
  const childBirths = document.querySelectorAll('input[name="childBirth[]"]');
  const childCustody = document.querySelectorAll('input[name="childCustody[]"]');
  const childAllowance = document.querySelectorAll('input[name="childAllowance[]"]');
  
  pdf.setDrawColor(0);
  pdf.rect(margin, y, contentWidth, 6);
  pdf.setFontSize(7);
  pdf.setFont('Helvetica', 'bold');
  const colChild = contentWidth / 5;
  pdf.text('Kitsba', margin + colChild * 0.5, y + 4, { align: 'center' });
  pdf.text('Bechezka', margin + colChild * 1.5, y + 4, { align: 'center' });
  pdf.text('Taarich Leida', margin + colChild * 2.5, y + 4, { align: 'center' });
  pdf.text('Mispar Zehut', margin + colChild * 3.5, y + 4, { align: 'center' });
  pdf.text('Shem Yeled', margin + colChild * 4.5, y + 4, { align: 'center' });
  y += 6;
  
  let hasChildren = false;
  for (let i = 0; i < childNames.length && i < 6; i++) {
    if (childNames[i].value) {
      hasChildren = true;
      pdf.rect(margin, y, contentWidth, 6);
      pdf.setFont('Helvetica', 'normal');
      pdf.text(checkbox(childAllowance[i]?.checked), margin + colChild * 0.5, y + 4, { align: 'center' });
      pdf.text(checkbox(childCustody[i]?.checked), margin + colChild * 1.5, y + 4, { align: 'center' });
      pdf.text(formatHebrewDate(childBirths[i].value), margin + colChild * 2.5, y + 4, { align: 'center' });
      pdf.text(childIds[i].value || '', margin + colChild * 3.5, y + 4, { align: 'center' });
      pdf.text(childNames[i].value, margin + colChild * 4.5, y + 4, { align: 'center' });
      y += 6;
    }
  }
  if (!hasChildren) {
    pdf.rect(margin, y, contentWidth, 6);
    pdf.setFont('Helvetica', 'italic');
    pdf.text('Ein yeladim', pageWidth / 2, y + 4, { align: 'center' });
    y += 6;
  }
  y += 2;
  
  drawSectionHeader('HACHNASOT MEMAASIK ZE', 'D');
  
  const workStart = formatHebrewDate(document.getElementById('workStartDate').value);
  const incomeType = document.querySelector('input[name="incomeType"]:checked');
  const incomeLabels = {
    'monthly': 'Maskoret Chodesh',
    'additional': 'Misra Nosefet', 
    'partial': 'Maskoret Chelkit',
    'daily': 'Schar Yomi',
    'pension': 'Kitsba',
    'scholarship': 'Milga'
  };
  const incomeText = incomeType ? incomeLabels[incomeType.value] || incomeType.value : '';
  
  drawCell(margin, contentWidth / 2, cellH, 'Taarich Tchilat Avoda', workStart);
  drawCell(margin + contentWidth / 2, contentWidth / 2, cellH, 'Sug Hachnasa', incomeText);
  y += cellH + 2;
  
  drawSectionHeader('HACHNASOT ACHEROT', 'H');
  const otherIncome = document.querySelector('input[name="otherIncome"]:checked');
  pdf.setFontSize(8);
  pdf.setFont('Helvetica', 'normal');
  pdf.rect(margin, y, contentWidth, 8);
  pdf.text(checkbox(otherIncome?.value === 'none') + ' Ein hachnasot acherot   ' + 
           checkbox(otherIncome?.value === 'yes') + ' Yesh hachnasot acherot', 
           pageWidth - margin - 5, y + 5, { align: 'right' });
  y += 10;
  
  drawSectionHeader('PIRTEI BEN/BAT HAZUG', 'V');
  const spouseId = document.getElementById('spouseId').value || '';
  const spouseFirst = document.getElementById('spouseFirstName').value || '';
  const spouseLast = document.getElementById('spouseLastName').value || '';
  const spouseIncome = document.querySelector('input[name="spouseIncome"]:checked');
  
  if (spouseId || spouseFirst || spouseLast) {
    drawCell(margin, col3, cellH, 'Mispar Zehut', spouseId);
    drawCell(margin + col3, col3, cellH, 'Shem Mishpacha', spouseLast);
    drawCell(margin + col3 * 2, col3, cellH, 'Shem Prati', spouseFirst);
    y += cellH;
  } else {
    pdf.rect(margin, y, contentWidth, 6);
    pdf.setFont('Helvetica', 'italic');
    pdf.text('Lo duvach', pageWidth / 2, y + 4, { align: 'center' });
    y += 6;
  }
  y += 2;
  
  drawSectionHeader('BAKASHA LEPTOR O ZIKUI MIMAS', 'CH');
  
  const credits = [
    { id: 'credit1', text: '1. Toshav Israel' },
    { id: 'credit2a', text: '2a. Neche 100%' },
    { id: 'credit2b', text: '2b. Tagmul Chok Nechaim' },
    { id: 'credit3', text: '3. Yishuv Mezake' },
    { id: 'credit4', text: '4. Ole Chadash' },
    { id: 'credit5', text: '5. Ben/Bat Zug Lelo Hachnasa' },
    { id: 'credit6', text: '6. Mishpacha Chad Horit' },
    { id: 'credit7', text: '7. Yeladim Bechezka' },
    { id: 'credit8', text: '8. Yeladim' },
    { id: 'credit9', text: '9. Hore Yachid' },
    { id: 'credit10', text: '10. Yeladim Shelo Bechezka' },
    { id: 'credit11', text: '11. Yeladim Im Mugbalut' },
    { id: 'credit12', text: '12. Mezonot' },
    { id: 'credit13', text: '13. Gil 16-18' },
    { id: 'credit14', text: '14. Chayal Meshuchrar' },
    { id: 'credit15', text: '15. Sium Limudim' },
    { id: 'credit16', text: '16. Lochem Miluim' }
  ];
  
  pdf.setFontSize(7);
  let creditY = y;
  const creditColW = contentWidth / 2;
  let col = 0;
  
  credits.forEach((credit, idx) => {
    const el = document.getElementById(credit.id);
    const checked = el ? el.checked : false;
    const xPos = margin + (col * creditColW);
    
    if (idx % 2 === 0 && idx > 0) {
      creditY += 5;
    }
    col = idx % 2;
    
    pdf.text(checkbox(checked) + ' ' + credit.text, xPos + creditColW - 2, creditY + 4, { align: 'right' });
  });
  
  y = creditY + 8;
  
  drawSectionHeader('BAKASHA LETIEUM MAS', 'T');
  
  const taxAdj1 = document.getElementById('taxAdj1')?.checked || false;
  const taxAdj2 = document.getElementById('taxAdj2')?.checked || false;
  const taxAdj3 = document.getElementById('taxAdj3')?.checked || false;
  
  pdf.setFontSize(7);
  pdf.rect(margin, y, contentWidth, 8);
  pdf.text(checkbox(taxAdj1) + ' 1. Lo hayta hachnasa mitchilat shnat mas ad tchilat avoda etsel maasik ze', pageWidth - margin - 5, y + 5, { align: 'right' });
  y += 8;
  
  pdf.rect(margin, y, contentWidth, 8);
  pdf.text(checkbox(taxAdj2) + ' 2. Yesh li hachnasot nosafot mimaskoret kemefurat lehalan:', pageWidth - margin - 5, y + 5, { align: 'right' });
  y += 8;
  
  if (taxAdj2) {
    const otherEmpNames = document.querySelectorAll('input[name="otherEmpName[]"]');
    const otherEmpAddresses = document.querySelectorAll('input[name="otherEmpAddress[]"]');
    const otherEmpTiks = document.querySelectorAll('input[name="otherEmpTik[]"]');
    const otherEmpTypes = document.querySelectorAll('select[name="otherEmpType[]"]');
    const otherEmpIncomes = document.querySelectorAll('input[name="otherEmpIncome[]"]');
    const otherEmpTaxes = document.querySelectorAll('input[name="otherEmpTax[]"]');
    
    const empColW = contentWidth / 6;
    pdf.rect(margin, y, contentWidth, 6);
    pdf.setFont('Helvetica', 'bold');
    pdf.text('Mas Shenucha', margin + empColW * 0.5, y + 4, { align: 'center' });
    pdf.text('Hachnasa Chodshit', margin + empColW * 1.5, y + 4, { align: 'center' });
    pdf.text('Sug', margin + empColW * 2.5, y + 4, { align: 'center' });
    pdf.text('Tik Nikuyim', margin + empColW * 3.5, y + 4, { align: 'center' });
    pdf.text('Ktovet', margin + empColW * 4.5, y + 4, { align: 'center' });
    pdf.text('Shem Maasik', margin + empColW * 5.5, y + 4, { align: 'center' });
    y += 6;
    
    pdf.setFont('Helvetica', 'normal');
    for (let i = 0; i < otherEmpNames.length; i++) {
      if (otherEmpNames[i].value) {
        pdf.rect(margin, y, contentWidth, 5);
        pdf.text(otherEmpTaxes[i]?.value || '', margin + empColW * 0.5, y + 3.5, { align: 'center' });
        pdf.text(otherEmpIncomes[i]?.value || '', margin + empColW * 1.5, y + 3.5, { align: 'center' });
        pdf.text(otherEmpTypes[i]?.value || '', margin + empColW * 2.5, y + 3.5, { align: 'center' });
        pdf.text(otherEmpTiks[i]?.value || '', margin + empColW * 3.5, y + 3.5, { align: 'center' });
        pdf.text(otherEmpAddresses[i]?.value || '', margin + empColW * 4.5, y + 3.5, { align: 'center' });
        pdf.text(otherEmpNames[i].value, margin + empColW * 5.5, y + 3.5, { align: 'center' });
        y += 5;
      }
    }
    y += 2;
  }
  
  pdf.rect(margin, y, contentWidth, 8);
  pdf.text(checkbox(taxAdj3) + ' 3. Pkid Shoma isher tieum lefi ishur metzuraf', pageWidth - margin - 5, y + 5, { align: 'right' });
  y += 10;
  
  pdf.addPage();
  y = 10;
  
  pdf.setFontSize(7);
  pdf.setTextColor(100);
  pdf.text('0101/130', margin, y);
  pdf.text('2 / 2 :daf', pageWidth - margin, y, { align: 'right' });
  y += 8;
  
  drawSectionHeader('HATSHARA VECHATIMA', 'Y');
  
  pdf.setFillColor(255, 255, 230);
  pdf.rect(margin, y, contentWidth, 25, 'F');
  pdf.setDrawColor(0);
  pdf.rect(margin, y, contentWidth, 25);
  
  pdf.setFontSize(8);
  pdf.setFont('Helvetica', 'bold');
  pdf.setTextColor(0);
  pdf.text('HATSHARA:', pageWidth - margin - 5, y + 5, { align: 'right' });
  
  pdf.setFont('Helvetica', 'normal');
  pdf.setFontSize(7);
  pdf.text('Ani matshir/a ki hapratim shemasarti betofes ze heinam mele\'im venechonim.', pageWidth - margin - 5, y + 10, { align: 'right' });
  pdf.text('Yadua li ki hashmata o mesirat pratim lo nechonim heina avera al pkudat mas hachnasa.', pageWidth - margin - 5, y + 14, { align: 'right' });
  pdf.text('Ani mitchayev/et lehodia lemaasik al kol shinui bepratai toch shavua yamim mitaarich hashinui.', pageWidth - margin - 5, y + 18, { align: 'right' });
  y += 28;
  
  pdf.setFontSize(9);
  pdf.setFont('Helvetica', 'bold');
  pdf.text('CHATIMA DIGITALIT:', pageWidth - margin - 2, y, { align: 'right' });
  y += 5;
  
  const signatureImg = canvas.toDataURL('image/png');
  const sigBoxW = 70;
  const sigBoxH = 30;
  const signatureX = pageWidth - margin - sigBoxW;
  
  pdf.setDrawColor(0);
  pdf.setFillColor(255, 255, 255);
  pdf.rect(signatureX, y, sigBoxW, sigBoxH, 'FD');
  pdf.addImage(signatureImg, 'PNG', signatureX + 2, y + 2, sigBoxW - 4, sigBoxH - 4);
  
  y += sigBoxH + 5;
  
  const sigDate = document.getElementById('signatureDate').value;
  const timestamp = new Date().toISOString();
  
  pdf.setFontSize(8);
  pdf.setFont('Helvetica', 'normal');
  pdf.text('Taarich Chatima: ' + formatHebrewDate(sigDate), pageWidth - margin - 2, y, { align: 'right' });
  y += 5;
  pdf.setFontSize(7);
  pdf.setTextColor(80);
  pdf.text('Chatima Digitalit - Timestamp: ' + timestamp, pageWidth - margin - 2, y, { align: 'right' });
  y += 4;
  pdf.text('Beteum Takanot Rashut Hamisim Lechatima Electronit - Siman 6 Lepikodat Mas Hachnasa', pageWidth - margin - 2, y, { align: 'right' });
  
  y += 15;
  pdf.setDrawColor(150);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 8;
  
  pdf.setFontSize(8);
  pdf.setTextColor(0);
  pdf.setFont('Helvetica', 'bold');
  pdf.text('LEMILUI AL YEDEI HAMAASIK BILVAD:', pageWidth - margin - 2, y, { align: 'right' });
  y += 6;
  
  pdf.setFont('Helvetica', 'normal');
  pdf.setFontSize(7);
  pdf.rect(margin, y, contentWidth, 20);
  pdf.text('Taarich Kablat Hatofes: _____________', pageWidth - margin - 5, y + 5, { align: 'right' });
  pdf.text('Shem Memale Hatofes: _____________', pageWidth - margin - 5, y + 10, { align: 'right' });
  pdf.text('Chatima: _____________', pageWidth - margin - 5, y + 15, { align: 'right' });
  
  y += 30;
  pdf.setDrawColor(200);
  pdf.line(margin, y, pageWidth - margin, y);
  y += 5;
  pdf.setFontSize(6);
  pdf.setTextColor(100);
  pdf.text('Tofes 101 - Meudkan 01/2026 - Rashut Hamisim BeIsrael', pageWidth / 2, y, { align: 'center' });
  pdf.text('Mufak Beeemtsaut Maarechet Digitali - Tasiyeda - Taasiya Lemaan Chinuch Mitkadem', pageWidth / 2, y + 3, { align: 'center' });
  
  const fileName = 'Tofes_101_' + taxYear + '_' + (idNum || 'unsigned') + '.pdf';
  pdf.save(fileName);
}

updateStepIndicator();
</script>
</body>
</html>
